#çº¿æ€§å›å½’çš„ç®€æ´å®ç°
#ç¬¬ä¸€æ­¥ï¼Œimportä¸€äº›ä½ éœ€è¦çš„åŒ…
import numpy as np#NumPyæ˜¯ä¸€ä¸ªå¼€æºçš„Pythonç§‘å­¦è®¡ç®—åº“ï¼Œå®ƒå¹¿æ³›åº”ç”¨äºæ•°æ®ç§‘å­¦ã€æœºå™¨å­¦ä¹ ã€ç§‘å­¦è®¡ç®—å’Œæ•°æ®åˆ†æç­‰é¢†åŸŸã€‚NumPyçš„ä¸»è¦ç‰¹ç‚¹æ˜¯æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„å¤šç»´æ•°ç»„å¯¹è±¡ndarrayä»¥åŠç”¨äºæ“ä½œè¿™äº›æ•°ç»„çš„å‡½æ•°é›†ã€‚
import torch
from torch.utils import data#torch.utils.dataæ¨¡å—æä¾›äº†ç”¨äºæ•°æ®åŠ è½½å’Œå¤„ç†çš„å·¥å…·ï¼Œå®ƒå…è®¸ç”¨æˆ·æ›´é«˜æ•ˆåœ°åŠ è½½å’Œè®¿é—®æ•°æ®é›†ï¼Œç‰¹åˆ«æ˜¯åœ¨è®­ç»ƒæœºå™¨å­¦ä¹ æ¨¡å‹æ—¶ã€‚
from d2l import torch as d2l#fromçš„æ„æ€æ˜¯ä»d2låŒ…ä¸­ä»…import torchæ¨¡å—ï¼Œå¹¶ä»¥d2lä¸ºåˆ«å

#ç¬¬äºŒæ­¥ï¼Œç”Ÿæˆæ•°æ®é›†
true_w=torch.tensor([2,-3.4])
true_b=4.2
features,labels=d2l.synthetic_data(true_w,true_b,1000)#ç”Ÿæˆæ•°æ®é›†çš„å‡½æ•°ææ²åœ¨d2lé‡Œå†™å¥½äº†

#ç¬¬ä¸‰æ­¥ï¼Œè¯»å–æ•°æ®é›†
def load_array(data_arrays,batch_size,is_train=True):#æ„é€ ä¸€ä¸ªPyTorchæ•°æ®è¿­ä»£å™¨,å¸ƒå°”å€¼is_trainè¡¨ç¤ºæ˜¯å¦å¸Œæœ›æ•°æ®è¿­ä»£å™¨å¯¹è±¡åœ¨æ¯ä¸ªè¿­ä»£å‘¨æœŸå†…æ‰“ä¹±æ•°æ®
    dataset=data.TensorDataset(*data_arrays)#data_arraysæ˜¯ä¸€ä¸ªåŒ…å«å¤šä¸ªå…ƒç´ çš„åˆ—è¡¨æˆ–å…ƒç»„ï¼Œä½¿ç”¨*data_arraysä¼šå°†åˆ—è¡¨æˆ–å…ƒç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ä½œä¸ºå•ç‹¬çš„å‚æ•°ä¼ é€’ç»™å‡½æ•°ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥æ–¹ä¾¿åœ°å°†ä¸€ä¸ªåŒ…å«å¤šä¸ªå…ƒç´ çš„é›†åˆä¼ é€’ç»™ä¸€ä¸ªæ¥å—å¤šä¸ªå‚æ•°çš„å‡½æ•°ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨åœ°é€ä¸ªæŒ‡å®šæ¯ä¸ªå‚æ•°ã€‚å®é™…ä¸ŠTensorDatasetè¿™ä¸ªå‡½æ•°çš„å‚æ•°å½¢å¼å°±æ˜¯*tensorsï¼Œtensorsæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå¼ é‡ï¼Œè¿™äº›å¼ é‡åœ¨æ•°æ®é›†ä¸­è¢«çœ‹ä½œæ˜¯ä¸€ç»„æ ·æœ¬ï¼Œæ¯ä¸ªæ ·æœ¬ç”±è¿™äº›å¼ é‡ä¸­å¯¹åº”ä½ç½®çš„å…ƒç´ ç»„æˆï¼Œæœ€ç»ˆæ‹†æˆ1000ä¸ªæ ·æœ¬ï¼Œå­˜åœ¨dataseté‡Œ
    return data.DataLoader(dataset, batch_size,shuffle=is_train)#ç”¨ä¸Šæ–‡çš„TensorDatasetå¯¹è±¡ï¼Œè¿›ä¸€æ­¥ç”ŸæˆDataLoaderæ•°æ®è¿­ä»£å™¨ï¼Œå°†è¾“å…¥çš„æ•°æ®æ•°ç»„åŠ è½½åˆ° DataLoader ä¸­ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¯ä»¥ç”¨äºè¿­ä»£çš„ DataLoader å¯¹è±¡ï¼Œå¸ƒå°”å€¼is_trainè¡¨ç¤ºæ˜¯å¦å¸Œæœ›æ•°æ®è¿­ä»£å™¨å¯¹è±¡åœ¨æ¯ä¸ªè¿­ä»£å‘¨æœŸå†…æ‰“ä¹±æ•°æ®

batch_size=10
data_iter=load_array((features,labels),batch_size)

print(next(iter(data_iter)))
#DataLoader æ˜¯è‡ªåŠ¨æ§åˆ¶è¿­ä»£çš„ã€‚åœ¨ä½¿ç”¨ DataLoader åŠ è½½æ•°æ®é›†æ—¶ï¼Œå¯ä»¥ç›´æ¥åœ¨ for å¾ªç¯ä¸­ä½¿ç”¨å®ƒæ¥è¿­ä»£æ•°æ®é›†çš„æ‰¹æ¬¡æ•°æ®ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ iter(...) æˆ– next(...) å‡½æ•°,è¿™é‡Œæˆ‘ä»¬ä¸ºäº†éªŒè¯æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Œå…ˆè½¬æ¢ä¸ºiterï¼Œæ‰‹åŠ¨æ§åˆ¶è¯»å–å¹¶æ‰“å°ç¬¬ä¸€ä¸ªå°æ‰¹é‡æ ·æœ¬

#ç¬¬å››æ­¥ï¼Œå®šä¹‰æ¨¡å‹
from torch import nn#importç¥ç»ç½‘ç»œ
net = nn.Sequential(nn.Linear(2, 1))#Sequentialç±»å°†å¤šä¸ªå±‚ä¸²è”åœ¨ä¸€èµ·ã€‚ å½“ç»™å®šè¾“å…¥æ•°æ®æ—¶ï¼ŒSequentialå®ä¾‹å°†æ•°æ®ä¼ å…¥åˆ°ç¬¬ä¸€å±‚ï¼Œ ç„¶åå°†ç¬¬ä¸€å±‚çš„è¾“å‡ºä½œä¸ºç¬¬äºŒå±‚çš„è¾“å…¥ï¼Œä»¥æ­¤ç±»æ¨ï¼Œnn.Linear(2, 1)è¡¨ç¤ºä»è¾“å…¥ç»´åº¦ä¸º 2 åˆ°è¾“å‡ºç»´åº¦ä¸º 1 çš„çº¿æ€§å˜æ¢ã€‚å³featuresæ˜¯2ç»´ï¼Œè¾“å‡ºçš„labelæ˜¯1ç»´,å®ƒä¼šæŒ‰ç…§output=inputÃ—weight+biasè‡ªåŠ¨æ„å»ºå…¨è¿æ¥å±‚ï¼Œ

#ç¬¬äº”æ­¥ï¼Œåˆå§‹åŒ–æ¨¡å‹å‚æ•°
net[0].weight.data.normal_(0,0.01)
net[0].bias.data.fill_(0)

#ç¬¬å…­æ­¥ï¼Œå®šä¹‰æŸå¤±å‡½æ•°
loss=nn.MSELoss()#è®¡ç®—å‡æ–¹è¯¯å·®ä½¿ç”¨çš„æ˜¯MSELossç±»ï¼Œä¹Ÿç§°ä¸ºå¹³æ–¹ğ¿2èŒƒæ•°, é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒè¿”å›æ‰€æœ‰æ ·æœ¬æŸå¤±çš„å¹³å‡å€¼ã€‚

#ç¬¬ä¸ƒæ­¥ï¼Œå®šä¹‰ä¼˜åŒ–ç®—æ³•
trainer = torch.optim.SGD(net.parameters(), lr=0.03)#ç”Ÿæˆä¸€ä¸ªä¼˜åŒ–å™¨å¯¹è±¡ï¼Œnet.parameters()è¿”å›netçš„å…¨éƒ¨å¾…æ±‚å‚æ•°ï¼Œå³ä¸Šæ–‡çš„weightå’Œbias,å­¦ä¹ ç‡0.03ï¼Œ

#ç¬¬å…«æ­¥ï¼Œè®­ç»ƒ
num_epochs=3
for epoch in range(num_epochs):
    for X,y in data_iter:
        l=loss(net(X),y)#netæ˜¯æ¨¡å‹
        trainer.zero_grad()
        l.backward()#åå‘ä¼ é€’æ¢¯åº¦
        trainer.step()#æ ¹æ®æ¢¯åº¦æ›´æ–°å‚æ•°
    l = loss(net(features), labels)#è¾“å‡ºè¿™ä¸€è½®çš„è¯¯å·®
    print(f'epoch {epoch + 1}, loss {l:f}')

w = net[0].weight.data
print('wçš„ä¼°è®¡è¯¯å·®ï¼š', true_w - w.reshape(true_w.shape))
b = net[0].bias.data
print('bçš„ä¼°è®¡è¯¯å·®ï¼š', true_b - b)
        








print('Hello World')
